# px4_uav_patrol

ROS 2 package for executing PX4 patrol missions through waypoints for UAVs with energy use and distance logging.

## Setup instructions
1. Follow the [Installation and Setup instructions from the PX4 Guide](https://docs.px4.io/main/en/ros2/user_guide#installation-setup) to install and set up the PX4 development toolchain and install ROS 2 and its dependencies, and set up a ROS 2 workspace. You will need to running on Ubuntu 22.04 and using ROS Humble.
2. In your ROS 2 workspace, clone the following repositories (including this one). Skip the ones you already cloned in Step 1.
``` bash
cd ~/<ros2 workspace>/src
git clone https://github.com/PX4/px4_msgs.git
git clone https://github.com/PX4/px4_ros_com.git
git clone --recursive https://github.com/Auterion/px4-ros2-interface-lib
git clone https://github.com/mariojerez/px4_uav_patrol.git # <-- this repo
```
3. Source the ROS 2 development environment into the current terminal and compile the workspace using colcon:
``` bash
cd ..
source /opt/ros/humble/setup.bash
colcon build
```
4. Source the local_setup.bash:
``` bash
source install/local_setup.bash
```
5. Install [QGC](https://qgroundcontrol.com/)

## Run a mission
1. Start PX4 SITL for specific wind conditions. To make the windy environment that you want, make a copy of ```PX4-Autopilot/Tools/simulation/gz/worlds/windy.sdf``` and take a look at the file. Change the name from windy to something specific to the wind condition you want. Make sure ```enable_wind``` is ```true```. Adjust the wind vector here:
``` sdf
<wind>
      <linear_velocity>East North Up></linear_velocity>
</wind>
```
2. Generate a mission that PX4 can execute. It will convert the waypoints to global longitude, latitude coordinates if waypoints are originally given as relative locations in meters. The files in the ```scenarios``` and ```tours``` directories were generated using [LKH-DW](https://github.com/mariojerez/LKH-DW).
``` bash
python3 src/px4_uav_patrol/gen_patrol_mission.py <Name of scenario, e.g., 37SquareFarmCorner> --dir-to-tsp src/px4_uav_patrol/scenarios --dir-to-tour src/px4_uav_patrol/tours --out-dir <directory where you want the PX4 missions>
```
3. Run PX4 using your windy world:
``` bash
cd ~/PX4-Autopilot
PX4_GZ_WORLD=<windy world name> make px4_sitl gz_x500
```
4. Run the micro XRCE agent in a different terminal:
``` bash
MicroXRCEAgent udp4 -p 8888
```
5. Source local workspace and run a patrol mission in a different terminal:
``` bash
cd ~/<ros2 workspace>
source install/local_setup.bash
ros2 run px4_uav_patrol patrol_mission   --ros-args   -p mission_file:=<path/to/mission.mission.json>   -p mission_id:=<mission id that will appear in energy log>
```
6. Open QGC, switch to ```Patrol Mission``` mode, and arm the UAV. You should now see the drone take off in Gazebo and see it moving in QGC as it flies through its waypoints. Once it lands, it should update ```energy_log.csv``` with data from its tour.


<img width="942" height="603" alt="LKHDe20n20" src="https://github.com/user-attachments/assets/2545fc9e-2e5d-4b9b-8c8a-57aaa6d556ac" />

Tour generated by LKH-D (using [LKH-DW](https://github.com/mariojerez/LKH-DW) and setting wind to 0), not accounting for wind.


<img width="944" height="604" alt="LKHDWe10n10" src="https://github.com/user-attachments/assets/ddbea732-9792-4d9b-b945-06a2e7a45a62" />

Tour generated by [LKH-DW](https://github.com/mariojerez/LKH-DW) for wind = (10 m/s East, 10 m/s North).


<img width="941" height="601" alt="LKHDWe20n20" src="https://github.com/user-attachments/assets/fe451a87-cb43-4274-8cb2-c0a976a76819" />

Tour generated by [LKH-DW](https://github.com/mariojerez/LKH-DW) for wind = (20 m/s East, 20 m/s North).

## Dependencies
- ROS 2 Humble
- PX4 ROS 2 Interface
- px4_msgs
- Gazebo / PX4 SITL

## License
BSD-3-Clause
